name: Validate Charts

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: YAML Lint
        uses: ibiqlik/action-yamllint@v3
        with:
          config_file: .yamllint.yaml

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Helm Lint
        run: |
          for chart in charts/*/; do
            helm lint "$chart"
          done

      - name: Kube-linter
        uses: stackrox/kube-linter-action@v1
        with:
          directory: charts/
          config: .kube-linter.yaml

  validate:
    name: Validate K8s Schemas
    runs-on: ubuntu-latest
    env:
      # renovate: datasource=github-releases depName=yannh/kubeconform
      KUBECONFORM_VERSION: "v0.6.4"
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Cache kubeconform
        uses: actions/cache@v4
        id: cache-kubeconform
        with:
          path: /usr/local/bin/kubeconform
          key: kubeconform-${{ env.KUBECONFORM_VERSION }}

      - name: Install kubeconform
        if: steps.cache-kubeconform.outputs.cache-hit != 'true'
        run: |
          TARBALL="kubeconform-linux-amd64.tar.gz"
          wget -q "https://github.com/yannh/kubeconform/releases/download/${KUBECONFORM_VERSION}/${TARBALL}"
          tar xf "${TARBALL}"
          sudo mv kubeconform /usr/local/bin/

      - name: Validate manifests
        run: |
          for chart in charts/*/; do
            echo "Validating $chart"
            helm template "$chart" | kubeconform -strict -summary -ignore-missing-schemas
          done

  security:
    name: Security Scan (Informational)
    runs-on: ubuntu-latest
    # Security scans are informational - intentional configs (privileged, hostNetwork) flagged
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Helm
        uses: azure/setup-helm@v4

      - name: Trivy IaC scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'charts/'
          severity: 'CRITICAL'
          exit-code: '0'

      - name: Kubescape scan
        uses: kubescape/github-action@main
        continue-on-error: true
        with:
          files: "charts/"
          frameworks: "NSA"
          severityThreshold: "critical"

      - name: Checkov scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: charts/
          framework: kubernetes
          quiet: true
          soft_fail: true
